# This action originally modeled off of the Debian build action:
# https://salsa.debian.org/wouter/ola/-/blob/a38a396f6994b2b1af8efec9e208aee4e67f77aa/.gitlab-ci.yml

name: debian
on: [push, pull_request]
jobs:
  debian-build:
    name: 'Debian Build ${{ matrix.image_tag }} amd64'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image_tag: [stable, testing, unstable]
    container: debian:${{ matrix.image_tag }}
    steps:
      - uses: actions/checkout@master
      - name: Update package database
        run: apt-get update -y
      - name: Install build tools
        run: apt-get -y install devscripts adduser fakeroot sudo
      - name: Install build dependencies
        run: mk-build-deps -t "apt-get -y -o Debug::pkgProblemResolver=yes --no-install-recommends" -i -r
      - name: Set up build user
        run: |
          adduser --disabled-password --gecos "" builduser
          chown -R builduser:builduser .
          chown builduser:builduser ..
      - name: Build
        run: sudo -u builduser dpkg-buildpackage -b -rfakeroot
      - name: Move built files
        run: |
          mkdir built
          dcmd mv ../*ges built/
      - name: Display structure of built files
        run: ls -alR
        working-directory: built
        continue-on-error: true
      - name: SHA256 built files
        shell: bash
        run: find . -type f -exec sha256sum {} \;
        working-directory: built
        continue-on-error: true
      - uses: actions/upload-artifact@v3
        with:
          name: ola-built-debian-${{ matrix.image_tag }}-amd64
          path: ./built
  debian-test:
    name: 'Debian Test ${{ matrix.image_tag }} amd64'
    needs: debian-build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image_tag: [stable, testing, unstable]
    container: debian:${{ matrix.image_tag }}
    steps:
      - uses: actions/checkout@master
      - name: Download build artifact
        uses: actions/download-artifact@v3
        with:
          name: ola-built-debian-${{ matrix.image_tag }}-amd64
          path: built
      - name: Display structure of artifact files
        run: ls -alR
        working-directory: built
        continue-on-error: true
      - name: Update package database
        run: apt-get update -y
      - name: Install test tools
        run: apt-get -y install autopkgtest
      - name: Test
        run: autopkgtest built/*ges -- null
        continue-on-error: true # Temporarily allow failure, see https://github.com/OpenLightingProject/ola/pull/1812
